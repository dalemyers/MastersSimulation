

#include <omnetpp.h>


class APPositioner : public cSimpleModule
{
  protected:
    // configuration
    double playgroundLat,playgroundLon;  // NW corner of playground, in degrees
    double playgroundHeight,playgroundWidth;  // in meters
    double x, y; // longitude and latitude,
    int id; //Id of this bus
    simsignal_t mobilityStateChangedSignal;


  public:
     APPositioner();
     virtual ~APPositioner();

     double getX() { return x; }
     double getY() { return y; }
     int static_callback(void *obj, int argc, char **argv, char **azColName);


  protected:
    virtual void initialize();
    virtual void handleMessage(cMessage *msg);
    double* getPlaygroundPosition(double x, double y);

};

Define_Module(APPositioner);

APPositioner::APPositioner()
{
}

APPositioner::~APPositioner()
{
}


void APPositioner::initialize()
{
    //printf("BUS INITIALISATION\n");
    mobilityStateChangedSignal = registerSignal("mobilityStateChanged");
    id = getParentModule()->par("id");

    double lat = getParentModule()->par("y");
    double lon = getParentModule()->par("x");



    this->getParentModule()->getDisplayString().setTagArg("p", 0, x);
    this->getParentModule()->getDisplayString().setTagArg("p", 1, y);


    // schedule first move
    cMessage *timer = new cMessage("move");
    scheduleAt(simTime(), timer);
}

void APPositioner::handleMessage(cMessage *msg)
{
    delete msg;
}


double* APPositioner::getPlaygroundPosition(double x, double y){
    //This is duplicated in the access point app layer
    //Top left corner had coordinates 56, -3.4

    double TOPLEFTX = -3.4;
    double TOPLEFTY = 56;

    double* position = (double*)malloc(2*sizeof(double));

    double distanceBetweenDegreesLatitude = 111340.01;
    double distanceBetweenDegreesLongitude = 62473.28;
    double deltaLongitude = x - TOPLEFTX;
    double deltaLatitude = TOPLEFTY - y;

    position[0] = deltaLongitude*distanceBetweenDegreesLongitude;
    position[1] = deltaLatitude*distanceBetweenDegreesLatitude;

    return position;
}


